From 8427dfb54a20717fa10b192133c2492cc612e6dd Mon Sep 17 00:00:00 2001
From: Copilot <198982749+Copilot@users.noreply.github.com>
Date: Tue, 16 Dec 2025 11:30:27 +0700
Subject: [PATCH 4/7] Fix PCAP byte swapping on big-endian machines (#4715)

* Initial plan

* Fix PCAP byte swapping on big-endian machines

Replace pj_ntohl() with pj_swap32() for unconditional byte swapping.
pj_ntohl() is a no-op on big-endian systems, but we need to swap bytes
regardless of the host endianness when reading little-endian PCAP files.

Co-authored-by: nanangizz <24786011+nanangizz@users.noreply.github.com>

---------

Co-authored-by: copilot-swe-agent[bot] <198982749+Copilot@users.noreply.github.com>
Co-authored-by: nanangizz <24786011+nanangizz@users.noreply.github.com>
---
 pjlib-util/src/pjlib-util/pcap.c | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/pjlib-util/src/pjlib-util/pcap.c b/pjlib-util/src/pjlib-util/pcap.c
index a08442584..b0610b677 100644
--- a/pjlib-util/src/pjlib-util/pcap.c
+++ b/pjlib-util/src/pjlib-util/pcap.c
@@ -140,7 +140,7 @@ PJ_DEF(pj_status_t) pj_pcap_open(pj_pool_t *pool,
         file->swap = PJ_FALSE;
     } else if (file->hdr.magic_number == 0xd4c3b2a1) {
         file->swap = PJ_TRUE;
-        file->hdr.network = pj_ntohl(file->hdr.network);
+        file->hdr.network = pj_swap32(file->hdr.network);
     } else {
         /* If we add support for nanosecond pcap, adapt timestamp handling below */
 
@@ -261,10 +261,10 @@ PJ_DEF(pj_status_t) pj_pcap_read_udp_with_timestamp(
 
         /* Swap byte ordering */
         if (file->swap) {
-            tmp.rec.incl_len = pj_ntohl(tmp.rec.incl_len);
-            tmp.rec.orig_len = pj_ntohl(tmp.rec.orig_len);
-            tmp.rec.ts_sec = pj_ntohl(tmp.rec.ts_sec);
-            tmp.rec.ts_usec = pj_ntohl(tmp.rec.ts_usec);
+            tmp.rec.incl_len = pj_swap32(tmp.rec.incl_len);
+            tmp.rec.orig_len = pj_swap32(tmp.rec.orig_len);
+            tmp.rec.ts_sec = pj_swap32(tmp.rec.ts_sec);
+            tmp.rec.ts_usec = pj_swap32(tmp.rec.ts_usec);
         }
 
         rec_incl = tmp.rec.incl_len;
-- 
2.43.0

